'use strict';
const PLUGIN_NAME = 'gulp-featurify';
var through = require('through2'),
    gutil = require('gulp-util'),
    fs = require('fs'),
    PluginError = gutil.PluginError,
    path = require('path')

var featurify = function(hbs) {
    return through.obj(function (file, enc, callback) {
        let isBuffer = false,
            outBuffer=null

        if (file === null || file.isDirectory()) {
            this.push(file)
            return callback()
        }
        isBuffer = file.isBuffer()
        if(isBuffer){
            let templateContent = fs.readFileSync(file.path, 'utf8')
            let json = require(file.path.replace(".hbs", ".json"))
            templateContent = hbs.compile(templateContent)(json)
            let isWin = process.platform === "win32"
            let withoutRoot = isWin ? 
                file.path.replace(`${__dirname}\\templates\\scenarios\\`, "") :
                file.path.replace(`${__dirname}/templates/scenarios/`, "")
            if(isWin)
                withoutRoot = withoutRoot.replace(/\\/g, "/")
            withoutRoot = withoutRoot.replace(".hbs", "-autogenerated.feature")
            outBuffer = new Buffer(templateContent)
            var aFile = new gutil.File()
            aFile.path = withoutRoot
            aFile.contents = outBuffer
            callback(null,aFile)
        }else{
            this.emit('error',
                new PluginError(PLUGIN_NAME, 'Only Buffer format is supported'))
            callback()
        }
    })
}

module.exports = featurify